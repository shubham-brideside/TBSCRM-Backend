<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Brideside CRM</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Login</h1>
            <p class="subtitle">Sign in to Brideside CRM</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            
            <div id="message" class="message"></div>
            
            <p class="link-text">
                <a href="#" id="forgotPasswordLink">Forgot Password?</a>
            </p>
            
            <!-- Forgot Password Form (initially hidden) -->
            <div id="forgotPasswordSection" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
                <h3>Reset Password</h3>
                <p class="subtitle" style="margin-bottom: 1rem;">Enter your email address and we'll send you a link to reset your password.</p>
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label for="forgotEmail">Email *</label>
                        <input type="email" id="forgotEmail" name="email" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                    <button type="button" class="btn btn-secondary" id="cancelForgotPassword" style="margin-left: 0.5rem;">Cancel</button>
                </form>
                <div id="forgotPasswordMessage" class="message" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Dynamic API base URL - use current origin in production
        const API_BASE_URL = (window.location.origin || 'http://localhost:8080') + '/api';
        
        // Loader functions - define early before they're used
        function showLoader(message = 'Loading...') {
            hideLoader(); // Remove existing loader if any
            const overlay = document.createElement('div');
            overlay.className = 'loader-overlay';
            overlay.id = 'globalLoader';
            overlay.innerHTML = `
                <div class="loader-container">
                    <div class="loader-spinner"></div>
                    <p class="loader-text">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function hideLoader() {
            const loader = document.getElementById('globalLoader');
            if (loader) {
                loader.remove();
            }
        }
        
        // Function to handle login
        async function performLogin(email, password) {
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                messageDiv.className = 'message';
                messageDiv.textContent = '';
            }
            
            if (!email || !password) {
                if (messageDiv) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Please enter both email and password';
                }
                return;
            }
            
            try {
                showLoader('Logging in...');
                
                const formData = {
                    email: email.trim(),
                    password: password
                };
                
                console.log('Attempting login for:', email);
                
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Login response status:', response.status);
                
                const data = await response.json();
                console.log('Login response data:', data);
                
                if (response.ok && data.success) {
                    // Store token and user info
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data));
                    
                    if (messageDiv) {
                        messageDiv.className = 'message success';
                        messageDiv.textContent = 'Login successful! Redirecting...';
                    }
                    
                    // Redirect based on user role
                    let redirectUrl = '';
                    switch(data.data.role) {
                        case 'ADMIN':
                            redirectUrl = 'admin-dashboard.html';
                            break;
                        case 'CATEGORY_MANAGER':
                            redirectUrl = 'category-manager-dashboard.html';
                            break;
                        case 'MANAGER':
                            redirectUrl = 'manager-dashboard.html';
                            break;
                        case 'SALESREP':
                            redirectUrl = 'salesrep-dashboard.html';
                            break;
                        default:
                            redirectUrl = 'login.html';
                    }
                    
                    if (redirectUrl) {
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 1000);
                    }
                } else {
                    if (messageDiv) {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = data.message || 'Invalid email or password';
                    }
                    console.error('Login failed:', data);
                }
            } catch (error) {
                console.error('Login error:', error);
                const messageDiv = document.getElementById('message');
                if (messageDiv) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Error: ' + error.message;
                }
            } finally {
                hideLoader();
            }
        }
        
        // Function to handle forgot password
        async function handleForgotPassword(email) {
            const messageDiv = document.getElementById('forgotPasswordMessage');
            if (messageDiv) {
                messageDiv.className = 'message';
                messageDiv.textContent = '';
            }
            
            if (!email) {
                if (messageDiv) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Please enter your email address';
                }
                return;
            }
            
            try {
                showLoader('Sending password reset email...');
                
                const formData = {
                    email: email.trim()
                };
                
                console.log('Sending forgot password request for:', email);
                
                const response = await fetch(`${API_BASE_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Forgot password response status:', response.status);
                
                const data = await response.json();
                console.log('Forgot password response data:', data);
                
                if (response.ok && data.success) {
                    if (messageDiv) {
                        messageDiv.className = 'message success';
                        messageDiv.textContent = data.message || 'Password reset email sent! Please check your inbox.';
                    }
                    // Hide forgot password form after successful submission
                    setTimeout(() => {
                        document.getElementById('forgotPasswordSection').style.display = 'none';
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('forgotEmail').value = '';
                    }, 3000);
                } else {
                    if (messageDiv) {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = data.message || 'Failed to send password reset email. Please try again.';
                    }
                    console.error('Forgot password failed:', data);
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                const messageDiv = document.getElementById('forgotPasswordMessage');
                if (messageDiv) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Error: ' + error.message;
                }
            } finally {
                hideLoader();
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing login page');
            
            // Forgot password link click handler
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('forgotPasswordSection').style.display = 'block';
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('message').textContent = '';
                    document.getElementById('message').className = 'message';
                });
            }
            
            // Cancel forgot password handler
            const cancelForgotPassword = document.getElementById('cancelForgotPassword');
            if (cancelForgotPassword) {
                cancelForgotPassword.addEventListener('click', function() {
                    document.getElementById('forgotPasswordSection').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('forgotEmail').value = '';
                    document.getElementById('forgotPasswordMessage').textContent = '';
                    document.getElementById('forgotPasswordMessage').className = 'message';
                });
            }
            
            // Forgot password form submit handler
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            if (forgotPasswordForm) {
                forgotPasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('forgotEmail').value;
                    handleForgotPassword(email);
                });
            }
            
            // Check if token exists and redirect to appropriate dashboard
            const token = localStorage.getItem('token');
            if (token) {
                // Try to check if isTokenExpired is available, otherwise just check if token exists
                if (typeof isTokenExpired !== 'undefined') {
                    if (!isTokenExpired(token)) {
                        console.log('Valid token found, redirecting to dashboard');
                        const user = getCurrentUser();
                        if (user && user.role) {
                            let redirectUrl = '';
                            switch(user.role) {
                                case 'ADMIN':
                                    redirectUrl = 'admin-dashboard.html';
                                    break;
                                case 'CATEGORY_MANAGER':
                                    redirectUrl = 'category-manager-dashboard.html';
                                    break;
                                case 'MANAGER':
                                    redirectUrl = 'manager-dashboard.html';
                                    break;
                                case 'SALESREP':
                                    redirectUrl = 'salesrep-dashboard.html';
                                    break;
                            }
                            if (redirectUrl) {
                                window.location.href = redirectUrl;
                                return;
                            }
                        }
                    } else {
                        console.log('Token expired, clearing');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                    }
                }
            }
            
            // Attach form submit handler
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('Form submitted manually');
                    
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    
                    performLogin(email, password);
                });
                console.log('Form submit handler attached');
            } else {
                console.error('Login form not found!');
            }
            
            // Auto-fill and auto-submit from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            const passwordParam = urlParams.get('password');
            
            console.log('URL params - email:', emailParam, 'password:', passwordParam ? '***' : null);
            
            if (emailParam || passwordParam) {
                const emailInput = document.getElementById('email');
                const passwordInput = document.getElementById('password');
                
                if (emailParam && emailInput) {
                    emailInput.value = decodeURIComponent(emailParam);
                }
                if (passwordParam && passwordInput) {
                    passwordInput.value = decodeURIComponent(passwordParam);
                }
                
                // Auto-submit if both email and password are provided
                if (emailParam && passwordParam) {
                    console.log('Auto-submitting login with URL parameters');
                    // Clear URL parameters to avoid resubmission on refresh
                    window.history.replaceState({}, document.title, window.location.pathname);
                    // Perform login immediately
                    performLogin(decodeURIComponent(emailParam), decodeURIComponent(passwordParam));
                }
            }
        });
    </script>
    <script src="auth.js" onerror="console.error('Failed to load auth.js, but continuing anyway')"></script>
    <script>
        // Helper function to get current user (if auth.js loads after this)
        function getCurrentUser() {
            if (typeof window.getCurrentUser === 'function') {
                return window.getCurrentUser();
            }
            const userStr = localStorage.getItem('user');
            if (!userStr) return null;
            try {
                return JSON.parse(userStr);
            } catch (error) {
                console.error('Error parsing user data:', error);
                return null;
            }
        }
    </script>
</body>
</html>


